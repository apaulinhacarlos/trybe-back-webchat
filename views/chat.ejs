<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <title>TrybeChat</title>
  </head>
  <body>
    <header>
      <h2 id="welcome-msg"></h2>
    </header>

    <main>
      <section>
        <div>
          <h3>NickName:</h3>
          <p id="user-id" data-testid="online-user"></p>
        </div>
        <div>
          <input id="input-name" type="text" placeholder="Mude seu Nickname" data-testid="nickname-box">
          <button id="btn-name" data-testid="nickname-button">Mudar</button>
        </div>
      </section>
  
      <br>

      <section>
        <div>
          <h3>TrybeChat:</h3>
          <input id="input-msg" type="text" placeholder="Digite sua Mensagem" data-testid="message-box">
          <button id="btn-msg" data-testid="send-button">Enviar</button>
        </div>
        <div>
          <ul id="chat">
            <% messages.forEach((msg) => {%>
              <li data-testid="message">
                <%= msg %>
              </li>
            <%})%>
          </ul>
        </div>
      </section>
    </main>

    <script>
      const socket = io('http://localhost:3000');
      socket.on('welcome', (msg) => {
        const welcomeMsg = document.getElementById('welcome-msg');
        welcomeMsg.innerText = msg;
      });

      socket.on('userId', (id) => {
        const userId = document.getElementById('user-id');
        const nickname = id.slice(0, 16);
        userId.innerText = nickname;
      });

      const btnChangeName = document.getElementById('btn-name');
      btnChangeName.addEventListener('click', () => {
        const inputNickName = document.getElementById('input-name');
        const userId = document.getElementById('user-id');
        userId.innerText = inputNickName.value;
        inputNickName.value = '';
      });

      socket.on('message', (msg) => {
        const chat = document.getElementById('chat');
        const newMsg = document.createElement('li');
        newMsg.innerText = msg;
        newMsg.setAttribute('data-testid', 'message');
        chat.appendChild(newMsg);
      });

      const btnSend = document.getElementById('btn-msg');
      btnSend.addEventListener('click', () => {
        const inputMessage = document.getElementById('input-msg');
        const userId = document.getElementById('user-id').innerHTML;
        const nickname = userId;
        const chatMessage = inputMessage.value;
        inputMessage.value = '';
        
        socket.emit('message', { chatMessage, nickname });
      });
    </script>
  </body>
</html>